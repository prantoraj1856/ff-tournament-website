rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ðŸ” Registrations Collection */
    match /registrations/{regId} {

      // ðŸ”Ž Anyone can read their own data (optional)
      allow read: if true;

      // âœ… Create with Anti-Scam Protection
      allow create: if request.auth != null
        && isValidRegistration()
        && !isDuplicateUID()
        && !isSameUserSameTournament();

      // âŒ User cannot update/delete
      allow update, delete: if false;
    }

    /* ðŸ” Helper Functions */

    function isValidRegistration() {
      return request.resource.data.ff_uid is string
        && request.resource.data.ff_uid.size() > 3
        && request.resource.data.tournamentId is string
        && request.resource.data.whatsapp is string
        && request.resource.data.status == "pending"
        && request.resource.data.createdAt == request.time;
    }

    // ðŸš« Same Free Fire UID â†’ Same Tournament
    function isDuplicateUID() {
      return exists(
        /databases/$(database)/documents/registrations/{
          request.resource.data.ff_uid
          + "_" +
          request.resource.data.tournamentId
        }
      );
    }

    // ðŸš« Same User â†’ Same Tournament once
    function isSameUserSameTournament() {
      return request.resource.data.userId != null
        && exists(
          /databases/$(database)/documents/registrations/{
            request.resource.data.userId
            + "_" +
            request.resource.data.tournamentId
          }
        );
    }
  }
}
